---
title: Power BI Premium 容量記憶體使用與最佳化
description: 了解 Power BI Premium 容量記憶體管理與最佳化。
ms.date: 04/30/2018
ms.topic: conceptual
ms.service: powerbi
ms.component: powerbi-admin
ms.author: susuresh
ms.reviewer: susuresh
author: suds001
manager: kfile
ms.openlocfilehash: 03c5e56c5f516bb1f09f51463d4c533185fbb63c
ms.sourcegitcommit: 2a7bbb1fa24a49d2278a90cb0c4be543d7267bda
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/26/2018
ms.locfileid: "34298450"
---
# <a name="power-bi-premium-capacity-resource-management-and-optimization"></a>Power BI Premium 容量資源管理與最佳化

本文描述 Power BI Premium 服務如何管理資源，並提供有關為您的解決方案進行規劃和最佳化的秘訣。

## <a name="premium-capacity-memory-management"></a>Premium 容量記憶體管理

 耗用 Premium 容量記憶體的項目包括：

* 已載入資料集所使用的記憶體
* 資料集重新整理 (已排定的和視需要進行的) 所使用的記憶體
* 報表查詢所使用的記憶體

針對您容量中的發行資料集發出要求時，系統會從永續性儲存體載入該資料集 (也稱為影像載入)。 如果讓資料集在記憶體中保持載入狀態，當未來有對此資料集發出的查詢時，將有助於快速回應查詢。 除了讓資料集在記憶體中保持載入狀態所需的記憶體之外，報表查詢和資料集重新整理也會耗用額外的記憶體。

### <a name="dataset-memory-estimation"></a>資料集記憶體預估

嘗試將資料集載入記憶體時，Power BI 會預估資料集完成所要求命令所需的記憶體數量。 資料集在記憶體中的大小通常大於儲存至磁碟時的大小。 重新整理資料集時，記憶體容量至少需要資料集閒置時所需記憶體數量的兩倍。

### <a name="overcommitting-capacity-eviction-and-reloading-of-datasets"></a>超量配置容量、收回及重新載入資料集

Power BI Premium 可提供您超量配置容量的優點。 例如，您發佈的資料集數量可以超出容量記憶體所能容納的數量。 如果在容量中發佈資料集所需的記憶體數量超出容量所能容納的數量，部分資料集將會個別儲存在永續性儲存體中。 永續性儲存體是與您每個容量關聯之 100 TB 儲存體的一部分。

那麼，哪些資料集會留在記憶體中，而其他資料集又會發生什麼情況？ 如先前所述，對某個資料集發出要求時，系統會將其載入到記憶體中 (影像載入)。 該要求可能是報表查詢或重新整理作業。

由於您可以超量配置容量，因此您的容量可能也會面臨記憶體壓力。 當容量面臨記憶體壓力時 (因為需要載入新的資料集，或對某些已載入資料集進行的查詢導致記憶體需求增加)，節點會「收回一或多個佔用容量記憶體的資料集」。 非作用中的資料集 (亦即目前並未執行任何查詢/重新整理作業的資料集) 是優先收回的對象，收回順序是以「最近最少使用的」(LRU) 資料集優先。 如果對已收回的資料集發出新的命令，服務就會嘗試將其重新載入到記憶體中，而可能將其他資料集收回。 此行為會藉由允許容量為超出其記憶體容納限制的資料集提供服務，讓使用上變得更有效率。

將資料集載入到記憶體中是代價非常高昂的作業。 視資料集大小而定，持續時間可能從小型資料集的幾秒鐘，到大型資料集 (例如高達 10 GB) 的數十秒或甚至數分鐘。 Premium 容量會藉由將最近最少使用的資料集儘可能地保留在記憶體中，來嘗試將需要載入容量的次數降到最低。 當需要額外的記憶體時，將必須收回某些資料集，而系統將會嘗試選擇對使用者體驗影響最小的資料集。 當需要額外的記憶體時，將必須收回某些資料集，而系統將會嘗試選擇對使用者體驗影響最小的資料集。 例如，系統會避免收回過去幾分鐘內積極使用的資料集，因為可能很快就會再次查詢這些資料集。

收回程序本身是一項快速作業。 如果資料集在收回時不是處於積極使用的狀態，使用者將無法判斷收回所帶來的影響程度。 不過，如果有太多資料集同時處於積極使用狀態，而沒有足夠的記憶體來容納它們全部，就可能進行很多收回。 這可能導致發生「猛移現象」(thrashing) 的情況，其中資料集會不斷地被收回再重新載入，而使用者則可能感覺到回應時間明顯變長和效能明顯下降。

### <a name="dataset-refresh-memory-requirement-competing-with-an-active-dataset-memory-requirement"></a>與作用中資料集記憶體需求競爭的資料集重新整理記憶體需求

資料集的重新整理可以依排程進行，或是由使用者視需要進行。 如先前所述，若要進行完整重新整理，所需的記憶體至少為已載入和閒置資料集記憶體大小的兩倍。 在開始重新整理之前，會先預估重新整理記憶體需求。 如果總記憶體需求超出容量中可用記憶體的數量，就會收回部分資料集。 選擇收回的候選項目時，會依據最近最少使用的資料集順序，亦即服務會嘗試儘可能地將最近使用過的資料集保留在記憶體中。

如果即使進行收回也無法取得所需的記憶體，系統就會將重新整理作業排入重試佇列。 服務會進行重試，直到成功或新的重新整理動作開始為止。

如果使用者對容量中的任何資料集發出互動式查詢，但因為重新整理正在進行中而沒有足夠的可用記憶體，該要求就會失敗而必須由使用者重試。

## <a name="cpu-resource-management-in-premium-capacity"></a>Premium 容量中的 CPU 資源管理

CPU 資源的主要取用者有兩個：

- 來自報表的查詢
- 重新整理 (處理中)

### <a name="queries-from-reports"></a>來自報表的查詢

報表查詢會耗用您容量的 CPU 資源。 如果您的報表有一些沒有效率的查詢，或是您有許多並行使用者，就可能耗用許多 CPU 資源，導致您的現有容量可能不足以應付此負載。

### <a name="refresh-parallelization-policy"></a>重新整理平行處理原則

記憶體不是唯一可能限制資料集重新整理的資源。 伺服器上的 V 核心數目也可能是一個因素。 由於每個重新整理作業都需要特定數目的 V 核心，因此會限制可平行執行的重新整理數目。 下表會詳細說明每一 SKU 的限制。 系統會將超出這些限制的額外重新整理排入佇列。

 | SKU  | 後端 V 核心  | 模型重新整理平行處理原則   |
 | --- | --- | --- |
 | A1  | 0.5  | 1  |
 | A2  | 1  | 2  |
 | A3  | 2  | 3  |
 | A4  | 4  | 6  |
 | A5  | 8  | 12  |
 | A6  | 16  | 24  |
 | EM1  | 0.5  | 1  |
 | EM2  | 1  | 2  |
 | EM3  | 2  | 3  |
 | P1  | 4  | 6  |
 | P2  | 8  | 12  |
 | P3  | 16  | 24  |
 | P4  | 32  | 48  |
 | P5  | 64  | 96  |

 > [!TIP]
> 如果您的重新整理發生延遲，請檢查您容量所支援的平行重新整理數目。

## <a name="example-scenarios"></a>範例案例

以下描述一些常見案例，以及服務所採取的動作：

 **同時提交 20 個排定的重新整理** – Power BI 會嘗試同時啟動前 *x* 個重新整理。 *x* 的值取決於該 SKU 的重新整理平行處理原則。 如果 Power BI 無法藉由收回非作用中資料集 (最近未使用的資料集) 取得足夠的記憶體，就不會同時啟動所有 *x* 個重新整理。 任何無法啟動的重新整理都會排入佇列，直到能夠啟動為止。

 **2 個重新整理同時執行，但記憶體只足以供一個重新整理完成作業** – 能夠完成作業的重新整理會啟動。 另一個重新整理會稍後進行重試。

 **在數個資料集進行重新整理時查詢大量資料集** – 如果沒有足夠的記憶體可供使用，Power BI 就會嘗試停止作用中的重新整理，讓互動式查詢優先執行。 這會降低重新整理效能。

 **資料集要求在目前容量大小上重新整理的記憶體太多** – 重新整理將會失敗。 系統不會嘗試藉由收回取得更多記憶體。

 **重新整理一個有記憶體耗用量大量暴增情況的單一資料集** – 如果該暴增量超出透過收回非作用中資料集所能取得的記憶體數量，系統就會等到稍後有足夠的記憶體來處理暴增量時，才重新嘗試重新整理。

 **針對某個資料集執行查詢，但該資料集無法透過收回所有非作用中資料集和重新整理取得足夠的記憶體** - 這些查詢會失敗。 針對這些類型的工作負載需求，應該購買更大的容量。

## <a name="troubleshooting-and-testing"></a>疑難排解與測試

如果報表執行速度很慢或沒有回應，一開始請只使用一個使用者來進行報表測試。 然後開始增加並行使用者負載來找出限制。 在許多情況下，調整 DAX (報表查詢) 即可大幅改變您報表的效能 (並提升您容量所支援的並行使用者數目)。

請使用 Azure 中的 Power BI Embedded 容量來測試不同的 SKU，然後判斷最適合您預期工作負載的 Premium SKU。 Power BI Embedded A4 SKU 等同於 P1、A5 = P2 及 A6 = P3。 您可以藉由在 Azure 入口網站中調升或調降規模，在 Azure 中輕鬆切換 SKU。 當您找到最適合您工作負載的 SKU 並已完成測試時，即可刪除該 SKU。

在某些情況下，在您電腦上開啟模型的 PBIX 檔案並檢查記憶體和 CPU 耗用情況，可提供問題的許多相關資訊。 這對非常大型的模型來說並無助益，但針對一些較小型的模型，請嘗試從您的電腦開啟、重新整理及查詢模型。 當您開啟模型時，請檢查模型大小、記憶體及所耗用的 CPU。 請嘗試重新整理並進行查詢。 請使用工作管理員來檢查本機 PBIX 檔案的檢查 CPU 和記憶體耗用量。 有時，您電腦上的這些計量本身便可透露出較低的 Premium 容量 (例如 P1/ P2) 可能不適合您的解決方案。
